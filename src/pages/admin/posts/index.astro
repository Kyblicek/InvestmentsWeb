---
import Layout from '../../../layouts/Layout.astro';
import { db } from '../../../server/db';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/prihlaseni');
}

const csrfToken = Astro.locals.csrfToken;
if (!csrfToken) {
  throw new Error('Missing CSRF token');
}

const posts = await db.post.findMany({
  orderBy: {
    updatedAt: 'desc',
  },
});

const formatDate = (date?: Date | null) => (date ? date.toLocaleString('cs-CZ') : '—');
---
<Layout title="Správa postů" description="Administrace blogových příspěvků." metaImage="/assets/IMG_6170.jpg">
  <section class="bg-[#F5F5F5] py-24">
    <div class="mx-auto flex w-full max-w-6xl flex-col gap-10 rounded-3xl bg-white p-10 shadow-lg">
      <header class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-neutral-500">Obsah</p>
          <h1 class="font-serif text-3xl">Příspěvky</h1>
        </div>
        <div class="flex flex-wrap justify-center gap-3 sm:justify-end">
          <a
            class="inline-flex items-center gap-2 rounded-full bg-neutral-900 px-6 py-3 text-sm uppercase tracking-[0.3em] text-black transition hover:bg-neutral-700"
            href="/admin"
          >
            Dashboard
          </a>
          <a
            class="inline-flex items-center gap-2 rounded-full bg-neutral-900 px-6 py-3 text-sm uppercase tracking-[0.3em] text-black transition hover:bg-neutral-700"
            href="/admin/posts/new"
          >
            + Nový post
          </a>
        </div>
      </header>

      <div class="overflow-x-auto rounded-2xl border border-neutral-200">
        <table class="min-w-full divide-y divide-neutral-200 text-left text-sm">
          <thead class="bg-neutral-50">
            <tr class="text-xs uppercase tracking-[0.3em] text-neutral-500">
              <th class="px-6 py-4">Název</th>
              <th class="px-6 py-4">Status</th>
              <th class="px-6 py-4">Publikováno</th>
              <th class="px-6 py-4">Akce</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-neutral-100">
            {posts.map((post) => (
              <tr>
                <td class="px-6 py-4 text-sm font-medium text-neutral-900">{post.title}</td>
                <td class="px-6 py-4">
                  <span
                    class:list={[
                      'inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em]',
                      post.status === 'PUBLISHED'
                        ? 'bg-emerald-100 text-emerald-700'
                        : 'bg-amber-100 text-amber-700',
                    ]}
                  >
                    {post.status === 'PUBLISHED' ? 'Publikováno' : 'Draft'}
                  </span>
                </td>
                <td class="px-6 py-4 text-sm text-neutral-600">{formatDate(post.publishedAt)}</td>
                <td class="px-6 py-4 text-sm">
                  <div class="flex flex-wrap justify-center gap-3 sm:justify-start">
                    <a
                      class="inline-flex items-center gap-2 rounded-full bg-neutral-900 px-4 py-2 text-xs uppercase tracking-[0.3em] text-white transition hover:bg-neutral-700"
                      href={`/admin/posts/${post.id}`}
                    >
                      Upravit
                    </a>
                    {post.status === 'DRAFT' && (
                      <form method="post" action={`/api/posts/${post.id}/publish`} class="inline">
                        <input type="hidden" name="csrfToken" value={csrfToken} />
                        <button
                          type="submit"
                          class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-2 text-xs uppercase tracking-[0.3em] text-white transition hover:bg-emerald-500"
                        >
                          Publikovat
                        </button>
                      </form>
                    )}
                  </div>
                </td>
              </tr>
            ))}
            {posts.length === 0 && (
              <tr>
                <td class="px-6 py-12 text-center text-sm text-neutral-500" colspan={4}>
                  Zatím žádné příspěvky.
                  <div class="mt-4">
                    <a
                      class="inline-flex items-center gap-2 rounded-full bg-neutral-900 px-6 py-2 text-xs uppercase tracking-[0.3em] text-white transition hover:bg-neutral-700"
                      href="/admin/posts/new"
                    >
                      Vytvořit první
                    </a>
                  </div>
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</Layout>
